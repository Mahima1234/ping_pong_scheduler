
<!DOCTYPE HTML>
<html>
    <head>
        <title>Join Bracket</title>
        <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no">
        <!--<link rel="stylesheet" type="text/css" href="style.css">-->
        <!--[if lt IE 9]>
          	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
        <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="style.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
        <script src="https://www.gstatic.com/firebasejs/4.1.2/firebase.js"></script>
        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g=" crossorigin="anonymous"></script>

        //Firebase Script
        <script>
          // Initialize Firebase
          var config = {
            apiKey: "AIzaSyCkugIWgBALhDDweghTdirBWhKpC59dBrs",
            authDomain: "ping-pong-scheduler.firebaseapp.com",
            databaseURL: "https://ping-pong-scheduler.firebaseio.com",
            projectId: "ping-pong-scheduler",
            storageBucket: "ping-pong-scheduler.appspot.com",
            messagingSenderId: "890197500377"
          };
          firebase.initializeApp(config);
        </script>
        //Join Screen Script
        <script>
            /*
            index.js
            */
            "use strict";

            var database = firebase.database();
            var playersRef = database.ref('details/players/');
            var databaseRef = database.ref('/details/');
            var tournamentRef = database.ref('details/tournament/')
            var keys;
            var nameStore = [];
            var countDownDate;

            function hasStarted(data)
            {
              var selectedDate = new Date(data);
              var now = new Date();
              now.setHours(0,0,0,0);
              console.log(now)
              if (selectedDate < now) {
                // selected date is in the past
                return true
              }else{
                return false
              }
            }

            function onLoad(data)
            {
              try{
                if(data.tournament.name != ""){
                  try {
                      keys = Object.keys(data.players);
                  }
                  catch(err) {
                  }
                  if(hasStarted(data.tournament.date) == true)
                  {
                    startTournament(true);
                  }else{
                    document.getElementById("Name").innerHTML = "Tournament Name: " + data.tournament.name;
                    document.getElementById("container").className = "visible";
                    updateList();
                    countDownDate = new Date(data.tournament.date).getTime();
                    startTimer();
                  }
                }else{
                  document.getElementById("Name").innerHTML = "Sorry, no tournaments right now :("
                }
              }
              catch(err){
                document.getElementById("Name").innerHTML = "Sorry, no tournaments right now :("
              }
            }

            function checkTournamentStatus()
            {
              databaseRef.once('value').then(function(snapshot) {
                // The Promise was "fulfilled" (it succeeded).
                onLoad(snapshot.val());
              }, function(error) {
                // The Promise was rejected.
                console.error(error);
              });
            }

            playersRef.on('child_added', function(snapshot) {
              var duplicate = false;
              for(var x=0;x<nameStore.length;x++)
              {
                if(nameStore[x] == snapshot.val().name)
                {
                    duplicate = true;
                    return;
                }
              }
              if(duplicate == false)
              {
                nameStore.push(snapshot.val().name)
              }
              updateList();
            });

            function updateList()
            {
                var tempString = "";
                for(var u = 0;u<nameStore.length;u++)
                {
                    tempString += nameStore[u] + "<br>"
                }
                document.getElementById("signedUp").innerHTML = tempString;
            }

            function enterName()
            {
              var newPostRef = playersRef.push()
              newPostRef.set({
                name: document.getElementById("name").value
              })
            }

            function startTimer()
            {
                var x = setInterval(function() {
                  var now = new Date().getTime();
                  var distance = countDownDate - now;
                  var days = Math.floor(distance / (1000 * 60 * 60 * 24));
                  var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                  var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                  var seconds = Math.floor((distance % (1000 * 60)) / 1000);
                  document.getElementById("startTime").innerHTML = days + "d " + hours + "h " + minutes + "m " + seconds + "s ";
                  if (distance < 0) {
                    clearInterval(x);
                    startTournament();
                  }
              }, 1000);
            }

            function startTournament(data)
            {
                if(data == true)
                {
                  var updates = {};
                  updates['/started'] = true;
                  tournamentRef.update(updates)
                }
            }

            //TODO: Gotta add the .on to update the list in case someone joins
            //TODO: If there is no tournament, then don't display any of the buttons
            //TODO: After I merge, run a script to check to see if
            //      1) A tournament exists
            //      2) A tournament has started
            //      3) Pull all data so I don't need to do multiple .onces
            //      4)

    		</script>
        //live-server
	</head>

	<body onload="checkTournamentStatus()" id="joinid">
    <div id="Name"></div>
    <div id="container" class="hidden">
      <div id="playerList">Participants:</div>
      <div id="signedUp"></div>
      <div id="startTime">00d 00h 00m 00s</div>
      <input type="text" placeholder="Put Name Here" id="name">
      <input type="button" id="enter" value="Enter the tournament" onClick="enterName()">
    </div>
  </body>

</html>
