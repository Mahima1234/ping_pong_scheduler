<!DOCTYPE HTML>
<html>
    <head>
        <title>Challenger Home</title>
        <style>
          .hidden{
              display:hidden;
              visibility:hidden;
              opacity:0;
              position: absolute;
              margin-top: -100px;
              margin-left: -100px;
          }
          .visible{
              display: auto;
              visibility:visible;
              opacity:1;
          }
        </style>
        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g=" crossorigin="anonymous"></script>
        <link rel='stylesheet' type='text/css' href='http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css'/>
        <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <script src="https://www.gstatic.com/firebasejs/4.1.2/firebase.js"></script>
        <script>
          $(function() {
            $( "#datepicker" ).datepicker({ minDate: 0});
          });
        </script>
        <script>
          // Initialize Firebase
          var config = {
            apiKey: "AIzaSyCkugIWgBALhDDweghTdirBWhKpC59dBrs",
            authDomain: "ping-pong-scheduler.firebaseapp.com",
            databaseURL: "https://ping-pong-scheduler.firebaseio.com",
            projectId: "ping-pong-scheduler",
            storageBucket: "ping-pong-scheduler.appspot.com",
            messagingSenderId: "890197500377"
          };
          firebase.initializeApp(config);
        </script>
    		<script>
          /*
          index.js
          */
          "use strict";
          var database = firebase.database();
          var overallRef = database.ref("details/")
          var tournamentRef = database.ref("details/tournament/");
          var loadQuery = tournamentRef.orderByChild('date');
          var playersRef = database.ref("details/players");
          var updatePlayersRef = playersRef.limitToLast(1);

          var openKeys  = [];
          var openNames = [];
          var openDates = [];

          var closedKeys  = [];
          var closedNames = [];
          var closedDates = [];

          var screenState = 1;
          var countDownDate;
          var currentJoinKey;
          var timerVariable;
          //TODO:
          //Add number of people in tournament next to dynamic list tags
          //Check to see if internet connection is lost

          function createTournament()
          {
            var tName = document.getElementById("tourName").value
            var tDate = document.getElementById("datepicker").value
            var tStart = document.getElementById("runMax").checked
            var tMax = document.getElementById("numPlayers").value

            if(tMax && tDate && tName != "" || null || undefined )
            {
              var newPostRef = tournamentRef.push()
              newPostRef.set({
                name: tName,
                date: tDate,
                maxPlayers: tMax,
                startOnMax: tStart,
                started: false
              });
              console.log("success")
            }else {
              console.log("failure")
            }
          }

          loadQuery.once('value', function(snapshot) {
              snapshot.forEach(function(data){
                if(data.val().started == false){
                  if(hasStarted(data.val().date) == false)
                  {
                    openKeys.push(data.key);
                    openNames.push(data.val().name);
                    openDates.push(data.val().date);
                  }else{
                    closedKeys.push(data.key);
                    closedNames.push(data.val().name);
                    closedDates.push(data.key);
                  }
                }else{
                  closedKeys.push(data.key);
                  closedNames.push(data.val().name);
                  closedDates.push(data.key);
                }
              });
              updateOpenTour();
              updateClosedTour();
            });

            function hasStarted(data)
            {
              for(var i=0;i<openKeys.length;i++)
              {
                if(timeDiff(openDates[i]) != false)
                {
                  startTournament(true, i)
                }
              }
            }

          tournamentRef.on('child_changed', function(snapshot){
            console.log(snapshot.val());
          });

          updatePlayersRef.on('child_added', function(snapshot) {
            if(snapshot.val()[currentJoinKey] != undefined)
            {
              updateList(snapshot.val()[currentJoinKey])
            }
          });

          function updateOpenTour()
          {
            for(var i = 0;i<openKeys.length;i++)
            {
                $("#listOpen").append('<li>' + openNames[i] + " | Start Dates: " + openDates[i] + '</li>')
                var $button = $('<button/>', {
                  type: 'button',
                  id: openKeys[i],
                  text: 'Join',
                  click: function() {
                    viewTour(this.id)
                  }
                });
                $button.appendTo('#listOpen');
            }
          }

          function updateClosedTour()
          {
            for(var i = 0;i<closedKeys.length;i++)
            {
                $("#listClosed").append('<li>' + closedNames[i] + '</li>')
                var $button = $('<button/>', {
                  type: 'button',
                  id: closedKeys[i],
                  text: 'View',
                  click: function() {
                    //viewTour(this.id)
                  }
                });
                $button.appendTo('#listClosed');
            }
          }

          function viewTour(indexK)
          {
            screenState = 2;
            transition(screenState);
            loadTournament(indexK);
          }

          function loadTournament(key)
          {
            overallRef.once('value').then(function(snapshot) {
              // The Promise was "fulfilled" (it succeeded).
              try{
                displayTournament(snapshot.val(),key);
              }catch(err){
                console.log(err)
              }
            }, function(error) {
              // The Promise was rejected.
              console.error(error);
            });
          }

          function displayTournament(data, objKey)
          {
              countDownDate = new Date(data.tournament[objKey].date).getTime();
              startTimer();
              document.getElementById("tNamePlace").innerHTML = "Tournament Name: " + data.tournament[objKey].name;
              currentJoinKey = objKey
              var objArray = Object.keys(data.players.playerId)
              for(var i=0;i<objArray.length;i++)
              {
                if(data.players.playerId[objArray[i]].tid == currentJoinKey){
                  updateList(objArray[i], data);
                }
              }

          }

          function updateList(keyOrName, data)
          {
              if(arguments.length == 2)
              {
                document.getElementById("signedUp").innerHTML += data.players.playerId[keyOrName].name + "<br>"
              }else{
                document.getElementById("signedUp").innerHTML += keyOrName + "<br>"
              }
          }

          function joinTournament()
          {
              if(document.getElementById("name").value != null || undefined || "")
              {
                var newPostRef = database.ref('details/players/playerId').push()
                newPostRef.set({
                  name: document.getElementById("name").value,
                  tid: currentJoinKey
                });
                updateList(document.getElementById("name").value)
              }
          }

          function startTimer()
          {
              timerVariable = setInterval(function() {
                var now = new Date().getTime();
                var distance = countDownDate - now;
                var days = Math.floor(distance / (1000 * 60 * 60 * 24));
                var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                var seconds = Math.floor((distance % (1000 * 60)) / 1000);
                document.getElementById("startTime").innerHTML = days + "d " + hours + "h " + minutes + "m " + seconds + "s ";
                if (distance < 0) {
                  clearInterval(timerVariable);
                  startTournament();
                }
            }, 1000);
          }

          function killTimer()
          {
            clearTimeout(timerVariable)
          }
          // 1 is home page
          // 2 is join screen
          function transition(screen)
          {
            if(screen == 1)
            {
              document.getElementById("screen1").className = "visile"
              document.getElementById("screen2").className = "hidden"
              document.getElementById("signedUp").innerHTML = ""
            }else if(screen == 2){
              document.getElementById("screen2").className = "visible"
              document.getElementById("screen1").className = "hidden"
            }else if(screen == 3){
              document.getElementById("screen2").className = "hidden"
              document.getElementById("screen1").className = "hidden"
            }
          }

          function homePage()
          {
            screenState = 1
            killTimer()
            transition(screenState)
          }

          //In Progress
          function hasStarted(data)
          {
            for(var i=0;i<openKeys.length;i++)
            {
              if(timeDiff(openDates[i]) != false)
              {
                startTournament(true, i)
                return true;
              }
            }
            return false;
          }

          function timeDiff(data)
          {
            var selectedDate = new Date(data);
            var now = new Date();
            now.setHours(0,0,0,0);
            console.log(now)
            if (selectedDate < now) {
              // selected date is in the past
              return true
            }else{
              return false
            }
          }

          function startTournament(data, pos)
          {
              if(data == true)
              {
                var updateStartRef = database.ref('details/tournament/open/'+openKeys[pos]);
                var updates = {};
                updates['/started'] = true;
                updateStartRef.update(updates)
              }
          }
    		</script>

    </head>


	<body style="overflow:hidden" onload="">
      <header>
        <nav>
          <h1>Ping Pong Tournament</h1>
          <a onClick="homePage()">Home</a>
        </nav>
      </header>
      <section id="screen1" class="visible">
        <div>
          <h2>Create new tournament<h2>
            Tournament Name:
            <input type="text" id="tourName" placeholder="Tourney Name"><br>
            Start Tourney When Max Players Hit?
            <input type="checkbox" id="runMax"><br>
            Number of Players needed to start:
            <select id="numPlayers">
              <option value=""></option>
              <option value="4">4</option>
              <option value="8">8</option>
              <option value="16">16</option>
              <option value="32">32</option>
            </select><br>
            Tourney Start Date:
            <input type="text" id="datepicker"><br>
            <input type="button" onClick="createTournament()" value="Generate it!">
        </div>

        <div>
          <h2 style="margin-bottom:0px;">Open Tournaments</h2>
          <div style="overflow:auto;height: 100px;display:inline-block; width: 30%;">
            <ul id="listOpen">

            </ul>
          </div>
        </div>
        <div>
          <h2 style="margin-bottom:0px;">In Progress Tournaments</h2>
          <div style="overflow:auto;height: 100px;display:inline-block;width: 30%;">
            <ul id="listClosed">

            </ul>
          </div>
        </div>
      </section>
      <section id="screen2" class="hidden">
          <div id="tNamePlace"></div>
          <div id="playerList">Participants:</div>
          <div id="signedUp"></div>
          <div id="startTime">00d 00h 00m 00s</div>
          <input type="text" placeholder="Put Name Here" id="name">
          <input type="button" id="enter" value="Enter the tournament" onClick="joinTournament()">
      </section>
      <section id="screen3" class="hidden">

      </section>
    <footer>
    </footer>
	</body>
</html>
